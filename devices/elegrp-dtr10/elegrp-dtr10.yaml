# Thank you to bennydiamond for pin numbers and inspiration for this config :)
# https://github.com/bennydiamond/elegrp_dtr10_dtr30_esphome_template/blob/master/.base.elegrp.dtr10_dtr30_template.yaml

substitutions:
  # default name is used as base for MAC suffix unique name generated by ESPHome
  name: elegrp-dtr10
  friendly_name: "ELEGRP DTR10 Touch Dimmer Switch"
  comment: ""

esphome:
  project:
    name: "broccoliboy.elegrp-dtr10"
    version: "1.0"

packages:
  hardware: !include ../../hardware/boards/cb2s.yaml
  base: !include ../../common/base.yaml

logger:
  level: ${log_level}
  baud_rate: 0  # This must be 0 to prevent conflicts with the dimmer

uart:
  rx_pin: RX1
  tx_pin: TX1
  baud_rate: 9600

tuya:
  # DPIDs processed from schema model: 000004ngxw
  id: id_tuya_device

text_sensor:
  - platform: tuya
    name: "TuyaMCU Version"
    sensor_datapoint: 113
    entity_category: diagnostic
  - platform: tuya
    name: "Hardware Version"
    sensor_datapoint: 109
    entity_category: diagnostic

switch:
  #- platform: tuya
  #  switch_datapoint: 110
  #  name: Countdown Action
  - platform: tuya
    switch_datapoint: 114
    name: "Set Brightness Min"
    id: id_switch_set_brightness_min
    entity_category: config

number:
  # Allows for setting brightness value without turning the light ON
  - platform: tuya
    number_datapoint: 2
    name: "Dimmer Brightness control"
    id: dimmer_brightness_control
    min_value: 1
    max_value: 100
    step: 1
    # TuyaMCU scale is 10 to 1000
    multiply: 10 
  - platform: tuya
    number_datapoint: 108
    name: "Longpress Brightness"
    id: id_number_longpress_brightness
    min_value: 10
    max_value: 1000
    step: 1
    entity_category: config
  - platform: tuya
    number_datapoint: 101
    name: "Indicator Brightness"
    id: indicator_brightness
    min_value: 0
    max_value: 100
    step: 1
    entity_category: config
  - platform: tuya
    number_datapoint: 5
    name: "Brightness Max"
    id: id_number_brightness_max
    min_value: 550
    max_value: 1000
    step: 1
    entity_category: config
  # User must activate "Set Brightness Min" switch before changing the value of this
  - platform: tuya
    number_datapoint: 3
    name: "Brightness Min"
    id: id_number_brightness_min
    min_value: 0
    max_value: 500
    step: 1
    entity_category: config
  #- platform: tuya
  #  number_datapoint: 6
  #  name: "Countdown 1"
  #  unit_of_measurement: S
  #  min_value: 0
  #  max_value: 86399
  #  step: 1
  #- platform: tuya
  #  number_datapoint: 111
  #  name: "Countdown Total"
  #  unit_of_measurement: S
  #  min_value: 0
  #  max_value: 86399
  #  step: 1

select:
  - platform: tuya
    enum_datapoint: 103
    name: "Fade On Speed"
    id: id_select_fade_on_speed
    optimistic: true
    options:
      0: "Immediate"
      1: "Fast"   # 1s
      2: "Medium" # 5s
      3: "Slow"   # 15s
    entity_category: config
  - platform: tuya
    enum_datapoint: 104
    name: "Fade Off Speed"
    id: id_select_fade_off_speed
    optimistic: true
    options:
      0: "Immediate"
      1: "Fast"   # 1s
      2: "Medium" # 5s
      3: "Slow"   # 15s
    entity_category: config
  - platform: tuya
    enum_datapoint: 4
    name: "Bulb Type"
    id: id_select_bulb_type
    optimistic: true
    options:
      0: "Cfl"
      1: "Incandescent"
      2: "Halogen"
      3: "Led"
    entity_category: config

light:
  - platform: tuya
    name: "Dimmer"
    id: dimmer
    dimmer_datapoint: 2
    min_value_datapoint: 2
    max_value: 1000
    switch_datapoint: 1

interval:
  # Workaround for rare occasions where indicator brightness is not being taken in by TuyaMCU
  - interval: 1min
    startup_delay: 1min
    then:
      - lambda: |-
          id(id_tuya_device).force_set_integer_datapoint_value(101, id(indicator_brightness).state);
          